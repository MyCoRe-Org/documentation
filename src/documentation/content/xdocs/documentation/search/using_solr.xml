<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE document PUBLIC "-//APACHE//DTD Documentation V2.0//EN" "http://forrest.apache.org/dtd/document-v20.dtd">

<document>

  <header>
    <title>SOLR und MyCoRe</title>
    <release>2018.06</release>
    <version>2018-06-01</version>
    <authors>
      <person email="[EMAIL PROTECTED]" name="Jens Kupferschmidt" />
      <person email="[EMAIL PROTECTED]" name="Kathleen Neumann" />
    </authors>
    <abstract>
      Dieses Kapitel beschäftigt sich mit der Einbindung der SOLR7-Suchmaschine in MyCoRe. Aktuell wird Version
      7.3 getestet und verwendet.
    </abstract>
  </header>

  <body>

    <section>
      <title>SOLR Konfiguration für MyCoRe</title>
      <p>
        Nach dem klar ist, auf welchem System der SOLR7-Server laufen soll, wurde gemäß der allgemeinen Anleitung
        unter
        <strong>Mit MyCoRe Starten -> SOLR7-Integration</strong>
        ein SOLR-Server aufgesetzt. Nun müssen entsprechend der benutzten Anwendungen ein oder mehrere SOLR-Cores
        angelegt werden. Diese stehen unter dem GitHub-Account MyCoRe-Org bereit. Für verschiedene Anwendungen
        sind ein oder mehrere Cores erforderlich. Da die SOLR-API noch nicht das dynamische Verteilen von Mapping-Dateien
        unterstützt, werden die Templates durch MyCoRe über GitHub bereitgestellt.
      </p>
      <p>
        Folgende Schritte sind durchzuführen, um einen neuen <strong>main</strong>-Core zu erstellen. Dieser ist so,
        oder in einer durch die Anwender erweiterten Form immer für eine MyCoRe-Anwendung erforderlich. Gleiches gilt
        dann natürlich auch für weitere Cores.
      </p>
<pre><![CDATA[cd .../solr-7.3.0/server/solr/configsets
git clone git@github.com:MyCoRe-Org/mycore_solr_configset_main.git
.../solr-7.3.0/bin/solr create -d mycore_solr_configset_main -c {my_core_name}]]></pre>
        <p>Anschließend kann über die Web-Oberfläche geprüft werden, ob der Core richtig angelegt wurde.</p>
        <p>Die Zuordnung der Cores zu den entsprechenden Core-Typen erfolgt mittels Properties (s. u.). Dabei ist die 
        Verbindung zwischen Core-Name und Core-Typ wie folgend anzugeben: <code>MCR.Solr.Core.{core_type}={core_name}</code>.
        Der Typ <em>main</em> stellt dabei den Standard-Core-Namen für MyCoRe-Anwendungen dar.</p>
        <p>
          Die Konfigurationen für die einzelnen SOLR-Suchfelder stehen nun in den entsprechenden Modulen. Hierbei gilt 
          nachfolgende  Struktur. Für einzelne Fälle kann es erforderlich sein, dass neben dem <em>main</em>-Core
          weitere Definitionen für andere Cores, z. B. <em>classification</em>-Core, definiert sind. Die Namenskonventionen
          für die einzelnen Felder sind auf der entsprechenden Doku-Seite beschrieben.
        </p>
<pre><![CDATA[{mycore-module}/src/main/resources/components/{module_name}/config/solr 
or
{application-module}/src/main/resources/config/{application-module}/solr

   .../main - the core that use each MyCoRe application
       .../solr-schema.json - filled if the module use SOLR schema definitions
       .../solr-config.json - filled if the module use SOLR configurations
       
   .../{other_name} - other core definitions
       .../solr-schema.json - filled if the module use SOLR schema definitions
       .../solr-config.json - filled if the module use SOLR configurations]]></pre>
      <p>Nun müssen dies Definitionen noch in den Core geladen werden. Pro Core ist je ein Ladevorgang notwendig.
      Sollen bereits bestehende / in MyCoRe vorhandene Felder in ihrer Definition geändert werden, so können diese
      mit <em>replace</em> in der JSON-Datei überschrieben werden.</p>
      <p><code>mycore.sh reload solr configuration for type {type_name}</code></p>
      <p><code>mycore.sh reload solr configuration for type main</code></p>
      <p>Anschließend sollte noch einmal über die Web-Oberfläche geprüft werden, ob der Core konfiguriert wurde.
      Auch ist im Log zu prüfen, ob SOLR nicht Definitionen abgelehnt hat. Ist alles okay, so ist der Core betriebsbereit.</p>
      <p>siehe <a href="https://lucene.apache.org/solr/guide/7_3/solr-control-script-reference.html" target="_blank">Solr Control Script Reference</a>, 
      <a href="https://lucene.apache.org/solr/guide/7_3/schema-api.html" target="_blank">Schema API</a> und 
      <a href="https://lucene.apache.org/solr/guide/7_3/config-api.html" target="_blank">Config API</a></p>
    </section>

    <section>
      <title>Erzeugen der zu speichernden Daten</title>
      <p>Die in SOLR zu speichernden Daten werden über eine Kette von XSLT-Transformern generiert. Hierfür ist das 
      Property <em>MCR.URIResolver.xslImports.solr-document</em> zuständig. Grundsätzlich in der Kette enthalten sind
      die Stylesheets <em>solr-basetemplate.xsl</em> und <em>mycoreobject-dynamicfields.xsl</em>. Weiter Transformer
      können dieser Kette angefügt werden (siehe Beispielcode). Der an SOLR ausgehende Datenstrom läßt sich im Web-Browser
      mit der URL <code>http://{myapp}/receive/{mycore_id}?XSL.Style=solr-document</code> überprüfen.</p>
<pre><![CDATA[<?xml version="1.0" encoding="UTF-8"?>
<xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
  xmlns:mcrxsl="xalan://org.mycore.common.xml.MCRXMLFunctions"
  xmlns:xlink="http://www.w3.org/1999/xlink"
  xmlns:xalan="http://xml.apache.org/xalan"
  exclude-result-prefixes="xalan xlink mcrxsl">
   
  <xsl:import href="xslImport:solr-document:viaf2solr.xsl" />
  
  <xsl:template match="mycoreobject[contains(@ID,'_{my_datamodel}_')]">
    <xsl:apply-imports />
    <!-- field name="viaf_name_all" type="text_general" multiValued="true" stored="true" -->
    <xsl:for-each select="./metadata/def.preferredName/preferredName">
      <field name="viaf_name_all">
        <xsl:value-of select="fullname/text()" />
      </field>
    </xsl:for-each>
    ...
  </template>
</stylesheet>]]></pre>
    </section>
    
    <section>
      <title>Properties für die SOLR-Komponente</title>
      <p>
        In LTS 2017.06 sind die Properties noch mit
        <em>MCR.Module-solr</em>
        statt mit
        <strong>MCR.Solr</strong>
        bezeichnet.
        in LTS 2018.06 ist das deprecate!!!
      </p>
      <div style="font-size:12px;">
        <table style="padding-left:3px;padding-right:3px;border:1px;">
          <tr>
            <th style="width:40%">Property in 2018</th>
            <th style="width=35%">Bedeutung</th>
            <th style="width=25%">in App.-Config</th>
          </tr>
          <tr>
            <td style="vertical-align:top;">MCR.Solr.ServerURL</td>
            <td style="vertical-align:top;">the URL to the SOLR server like http://mysolr.de:8983/</td>
            <td style="font-weight:bold">required</td>
          </tr>
          <tr>
            <td style="vertical-align:top;">MCR.Solr.Core.{core_type}</td>
            <td style="vertical-align:top;">the name of the core for the core type that will be used for this MyCoRe application</td>
            <td style="font-weight:bold">requiered</td>
          </tr>
          <tr>
            <td style="vertical-align:top;">MCR.Solr.Indexer.File.AccumulatorList</td>
            <td style="vertical-align:top;">???</td>
            <td></td>
          </tr>
          <tr>
            <td style="vertical-align:top;">MCR.Solr.Indexer.BulkSize</td>
            <td style="vertical-align:top;">default=100 ; Die Anzahl der objekte, die mit einem mal an SOLR geschickt werden.</td>
            <td></td>
          </tr>
          <tr>
            <td style="vertical-align:top;">MCR.Solr.Indexer.ThreadCount</td>
            <td style="vertical-align:top;">default=4 ; Anzahl der benutzten Threads</td>
            <td></td>
          </tr>
          <tr>
            <td style="vertical-align:top;">MCR.Solr.XMLProtocolVersion</td>
            <td style="vertical-align:top;">current=4.5</td>
            <td></td>
          </tr>
          <tr>
            <td style="vertical-align:top;">MCR.Solr.SelectProxy.MaxConnections</td>
            <td style="vertical-align:top;">default=20 ; max. Anzahl der Verbindungen zum SOLR-Server für select</td>
            <td></td>
          </tr>
          <tr>
            <td style="vertical-align:top;">MCR.Solr.SelectPath</td>
            <td style="vertical-align:top;">default=/select</td>
            <td></td>
          </tr>
          <tr>
            <td style="vertical-align:top;">MCR.Solr.UpdatePath</td>
            <td style="vertical-align:top;">default=/update</td>
            <td></td>
          </tr>
          <tr>
            <td style="vertical-align:top;">MCR.Solr.ExtractPath</td>
            <td style="vertical-align:top;">default=/update/extract</td>
            <td></td>
          </tr>
          <tr>
            <td style="vertical-align:top;">MCR.Solr.Proxy.WhiteList</td>
            <td style="vertical-align:top;">default=/select ; der Proxy akzeptiert nur die Liste davon</td>
            <td></td>
          </tr>
          <tr>
            <td style="vertical-align:top;">MCR.Solr.SolrClient.ConnectionTimeout</td>
            <td style="vertical-align:top;">default=0</td>
            <td></td>
          </tr>
          <tr>
            <td style="vertical-align:top;">MCR.Solr.SolrClient.SocketTimeout</td>
            <td style="vertical-align:top;">default=50000</td>
            <td></td>
          </tr>
          <tr>
            <td style="vertical-align:top;">MCR.Solr.ConcurrentSolrUpdateClient.Enabled</td>
            <td style="vertical-align:top;">default=true ; soll das Update parallel erfolgen?</td>
            <td></td>
          </tr>
          <tr>
            <td style="vertical-align:top;">MCR.Solr.ConcurrentSolrUpdateClient.QueueSize</td>
            <td style="vertical-align:top;">default=100</td>
            <td></td>
          </tr>
          <tr>
            <td style="vertical-align:top;">MCR.Solr.ConcurrentSolrUpdateClient.ThreadCount</td>
            <td style="vertical-align:top;">
              Wert entspricht dem Property
              <em>MCR.Solr.Indexer.ThreadCount</em>
            </td>
            <td></td>
          </tr>
          <tr>
            <td style="vertical-align:top;">MCR.Solr.SolrInputDocument.Factory</td>
            <td style="vertical-align:top;">default=org.mycore.solr.index.document.MCRSolrTransformerInputDocumentFactory</td>
            <td></td>
          </tr>
          <tr>
            <td style="vertical-align:top;">MCR.Solr.SolrInputDocument.Transformer</td>
            <td style="vertical-align:top;">default=mycoreobject-solrdocument</td>
            <td></td>
          </tr>
          <tr>
            <td style="vertical-align:top;">MCR.Solr.SolrInputDocument.Path.Factory</td>
            <td style="vertical-align:top;">default=org.mycore.solr.index.file.MCRSolrPathDocumentFactory</td>
            <td></td>
          </tr>
          <tr>
            <td style="vertical-align:top;">MCR.Solr.IndexHandler.Factory</td>
            <td style="vertical-align:top;">default=org.mycore.solr.index.handlers.MCRSolrLazyInputDocumentHandlerFactory</td>
            <td></td>
          </tr>
          <tr>
            <td style="vertical-align:top;">MCR.Solr.FileIndexStrategy</td>
            <td style="vertical-align:top;">default=org.mycore.solr.index.strategy.MCRSolrMimeTypeStrategie</td>
            <td></td>
          </tr>
          <tr>
            <td style="vertical-align:top;">MCR.Solr.MimeTypeStrategy.Pattern</td>
            <td style="vertical-align:top;">default=image/.*</td>
            <td></td>
          </tr>
          <tr>
            <td style="vertical-align:top;">MCR.Solr.DynamicFields</td>
            <td style="vertical-align:top;">default=true ; erzeugt auch dynamische Felder für SOLR</td>
            <td>Es sollte geprüft werden, ob die Übertragung  dynamischer Felder in der speziellen Anwendung
            erforderlich ist. Andernfalls sollte der Wert auf <em>false</em> gestellt werden.</td>
          </tr>
          <tr>
            <td style="vertical-align:top;">MCR.Solr.ContentBaseFields</td>
            <td style="vertical-align:top;">eine Liste von Feldnamen für allgemeine Derivate-Metadaten</td>
            <td></td>
          </tr>
          <tr>
            <td style="vertical-align:top;">MCR.Solr.AVExtenderFields</td>
            <td style="vertical-align:top;">eine Liste von Feldnamen für Video-Derivate-Metadaten</td>
            <td></td>
          </tr>
          <tr>
            <td style="vertical-align:top;">MCR.Solr.TikaFileds</td>
            <td style="vertical-align:top;">eine Liste von Feldnamen für Tika-Metadaten</td>
            <td></td>
          </tr>
          <tr>
            <td style="vertical-align:top;">MCR.Solr.JoinQueryFileds</td>
            <td style="vertical-align:top;">
              enthält die Liste der Properties
              <em>MCR.Solr.ContentBaseFields</em>
              ,
              <em>MCR.Solr.AVExtenderFields</em>
              ,
              <em>MCR.Solr.TikaFileds</em>
            </td>
            <td></td>
          </tr>
          <tr>
            <td style="vertical-align:top;">MCR.Solr.netsedDocuments</td>
            <td style="vertical-align:top;">default=true ; ???</td>
            <td></td>
          </tr>
        </table>
      </div>
    </section>

    <section>
      <title>SOLR-Abfragen über die MyCoRe-Java-API</title>
      <p> Mit diesem Code-Schnipsel soll demonstriert werden, wie ein Zugriff auf die SOLR-Daten mittels MyCoRe-API
        erfolgen kann.
      </p>
<pre><![CDATA[import org.apache.solr.client.solrj.SolrClient;
import org.apache.solr.client.solrj.SolrQuery;
import org.apache.solr.client.solrj.SolrServerException;
import org.apache.solr.common.SolrDocumentList;

import org.mycore.solr.MCRSolrClientFactory;
import org.mycore.solr.MCRSolrUtils;

...
        SolrClient solrClient = org.mycore.solr.MCRSolrCore.getClient()
        
        oder

        SolrClient solrClient = org.mycore.solr.MCRSolrClientFactory.getSolrClient();
        
        SolrQuery query = new SolrQuery();
        query.setQuery("title:foo");
        query.setRows(10);
        SolrDocumentList results = solrClient.query(query).getResults();

...]]></pre>
    </section>

  </body>
</document>

      